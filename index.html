<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PWA 長效迷霧探索 (7天版)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        /* 迷霧層 Canvas */
        #fog-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* 狀態列 */
        #status-bar {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            z-index: 2000;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            font-size: 13px;
            pointer-events: none;
            text-align: center;
        }

        /* 定位按鈕樣式 */
        #locate-btn {
            position: absolute;
            bottom: 40px;
            right: 20px;
            z-index: 2001; /* 必須高於地圖 */
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #locate-btn:active { transform: scale(0.95); }
        #locate-btn svg { width: 24px; height: 24px; fill: #333; }
        
        /* 載入中遮罩 */
        #loading {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            color: #fff; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="loading">系統初始化中...</div>
    <div id="map"></div>
    <canvas id="fog-canvas"></canvas>
    
    <div id="status-bar">
        迷霧時效: 7天 <br> 
        有效據點: <span id="point-count">0</span>
    </div>

    <button id="locate-btn" title="回到目前位置">
        <svg viewBox="0 0 24 24">
            <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
        </svg>
    </button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. 核心參數設定 ---
        const CONFIG = {
            // 7天 = 7 * 24 * 60 * 60 * 1000 毫秒
            fogTimeout: 604800000, 
            exploreRadius: 20,    // 探索半徑 (公尺)
            recordThreshold: 3,   // 移動超過 3 公尺才記錄新點
            initialZoom: 18,      // 初始 Zoom 18
            storageKey: 'fog_path_data_v1' // LocalStorage Key
        };

        // --- 2. 初始化地圖 ---
        // 預設先定在一個通用位置，等待 GPS 更新
        const map = L.map('map', { 
            zoomControl: false,
            attributionControl: false 
        }).setView([25.0330, 121.5654], CONFIG.initialZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- 3. 資料管理 (含 LocalStorage) ---
        let pathPoints = []; 
        let currentPosition = null; // [lat, lng]

        // 從 LocalStorage 讀取舊資料
        function loadData() {
            const raw = localStorage.getItem(CONFIG.storageKey);
            if (raw) {
                try {
                    const saved = JSON.parse(raw);
                    const now = Date.now();
                    // 讀取時順便過濾掉超過 7 天的過期資料
                    pathPoints = saved.filter(p => (now - p.lastVisited) < CONFIG.fogTimeout);
                    console.log(`已載入 ${pathPoints.length} 個有效路徑點`);
                } catch (e) {
                    console.error("讀取存檔失敗", e);
                }
            }
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
            drawFog(); // 載入後立即重繪
        }

        // 儲存資料到 LocalStorage (建議使用 debounce 避免太頻繁寫入)
        let saveTimeout;
        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                // 只存必要的欄位以節省空間 (最多存幾千點，若更多需考慮 IndexedDB)
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(pathPoints));
            }, 1000); // 延遲1秒寫入
        }

        // --- 4. 繪圖引擎 (Canvas) ---
        const canvas = document.getElementById('fog-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawFog();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawFog() {
            const now = Date.now();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 迷霧背景
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = `rgba(0, 0, 0, 0.9)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 準備挖洞 (Destination-Out)
            ctx.globalCompositeOperation = 'destination-out';
            
            // 計算當前縮放層級下的像素半徑
            // 公式：(實際公尺 / 每像素公尺)
            // 這裡使用更精確的緯度校正
            const centerLat = map.getCenter().lat;
            const metersPerPixel = 40075016.686 * Math.abs(Math.cos(centerLat * Math.PI / 180)) / Math.pow(2, map.getZoom() + 8);
            const pixelRadius = CONFIG.exploreRadius / metersPerPixel;

            const activePoints = [];

            pathPoints.forEach(p => {
                // 檢查 7 天過期
                if (now - p.lastVisited > CONFIG.fogTimeout) return;
                
                activePoints.push(p);

                // 畫布邊界檢查 (效能優化：只畫螢幕內的點)
                const point = map.latLngToContainerPoint([p.lat, p.lng]);
                
                // 寬鬆邊界檢查 (半徑外加一點 buffer)
                if (point.x < -pixelRadius || point.x > canvas.width + pixelRadius ||
                    point.y < -pixelRadius || point.y > canvas.height + pixelRadius) {
                    return; 
                }

                // 繪製柔邊圓形
                const gradient = ctx.createRadialGradient(point.x, point.y, pixelRadius * 0.5, point.x, point.y, pixelRadius);
                gradient.addColorStop(0, 'rgba(0,0,0,1)');
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = gradient;
                
                ctx.beginPath();
                ctx.arc(point.x, point.y, pixelRadius, 0, Math.PI * 2);
                ctx.fill();
            });

            // 如果有過期點被剔除，這裡會更新記憶體中的陣列
            if (activePoints.length !== pathPoints.length) {
                pathPoints = activePoints;
                saveData(); // 有刪除發生，存檔
            }
            
            document.getElementById('point-count').innerText = pathPoints.length;
        }

        // --- 5. 位置更新邏輯 ---
        function updateLocation(lat, lng) {
            const now = Date.now();
            let foundNearby = false;

            // 倒序搜尋，優先比對最近的點
            for (let i = pathPoints.length - 1; i >= 0; i--) {
                const p = pathPoints[i];
                const dist = map.distance([lat, lng], [p.lat, p.lng]);
                
                if (dist < CONFIG.recordThreshold) {
                    p.lastVisited = now; // 續命 (重置7天計時)
                    p.lat = lat; // 更新座標中心
                    p.lng = lng;
                    foundNearby = true;
                    // 若有變更，觸發存檔
                    saveData();
                    break;
                }
            }

            if (!foundNearby) {
                pathPoints.push({ lat, lng, lastVisited: now });
                saveData(); // 新增點，觸發存檔
            }

            requestAnimationFrame(drawFog);
        }

        // --- 6. GPS 與互動 ---
        let firstLocate = true;

        if ('geolocation' in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                currentPosition = [latitude, longitude];

                updateLocation(latitude, longitude);

                // 第一次定位成功時，自動飛到該處並設定 Zoom 17
                if (firstLocate) {
                    map.setView([latitude, longitude], CONFIG.initialZoom);
                    firstLocate = false;
                }

            }, (err) => {
                console.warn("GPS Error", err);
            }, {
                enableHighAccuracy: true, maximumAge: 0
            });
        }

        // 定位按鈕功能
        document.getElementById('locate-btn').addEventListener('click', () => {
            if (currentPosition) {
                map.flyTo(currentPosition, CONFIG.initialZoom, {
                    animate: true,
                    duration: 1.5
                });
            } else {
                alert("尚未獲取到 GPS 位置");
            }
        });

        // 地圖操作事件監聽
        map.on('move', () => requestAnimationFrame(drawFog));
        map.on('zoom', () => requestAnimationFrame(drawFog));

        // 啟動程式
        loadData();

    </script>
</body>
</html>